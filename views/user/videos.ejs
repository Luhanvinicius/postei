<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar V√≠deos - YouTube Automation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">üìπ YouTube Automation</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/user/dashboard">Dashboard</a>
                <a class="nav-link" href="/user/accounts">Vincular Contas</a>
                <a class="nav-link active" href="/user/videos">V√≠deos</a>
                <a class="nav-link" href="/user/scheduled">Agendados</a>
                <a class="nav-link" href="/user/published">Publicados</a>
                <span class="navbar-text me-3">Ol√°, <strong><%= user.username %></strong></span>
                <form action="/auth/logout" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-link nav-link text-white">Sair</button>
                </form>
            </div>
        </div>
    </nav>

    <main class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">üé¨ Gerenciar V√≠deos</h1>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">üìÅ Selecionar Pasta</h5>
                        <% if (defaultFolder) { %>
                            <div class="alert alert-info">
                                <strong>Pasta padr√£o:</strong> <%= defaultFolder %>
                                <button class="btn btn-sm btn-primary ms-2" onclick="loadDefaultFolder()">üìÇ Carregar V√≠deos</button>
                                <button class="btn btn-sm btn-outline-secondary ms-2" onclick="clearDefaultFolder()">Alterar</button>
                            </div>
                        <% } %>
                        <div class="mb-3">
                            <label for="folderInput" class="form-label">Escolha a pasta que cont√©m os v√≠deos:</label>
                            <input type="file" class="form-control" id="folderInput" webkitdirectory directory multiple accept="video/*">
                            <small class="text-muted">‚ö†Ô∏è O navegador pode mostrar um aviso sobre muitos arquivos, mas apenas v√≠deos ser√£o processados.</small>
                        </div>
                        <div class="mb-3" id="manualPathSection" style="<%= defaultFolder ? 'display: block;' : 'display: none;' %>">
                            <label class="form-label">Ou digite o caminho manualmente:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="folderPath" placeholder="Caminho da pasta (ex: F:\isauro\videos)" value="<%= defaultFolder ? defaultFolder.replace(/\\/g, '\\\\') : '' %>">
                                <button class="btn btn-secondary" onclick="scanFolder()">Escanear Pasta</button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-link p-0" onclick="toggleManualPath()">
                            <small>Ou digite o caminho manualmente</small>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="videosList" class="row" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">üìπ V√≠deos Encontrados</h5>
                        <div id="videosContainer"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="loading" class="text-center" style="display: none;">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
        </div>
    </main>

    <!-- Modal para Resultado da IA -->
    <div class="modal fade" id="aiResultModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">ü§ñ Conte√∫do Gerado com IA</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3" id="thumbnailSection" style="display: none;">
                        <label class="form-label fw-bold">üì∏ Thumbnail Gerado:</label>
                        <div class="text-center mb-2 p-3 bg-light rounded" style="border: 2px solid #dee2e6;">
                            <img id="aiResultThumbnail" src="" alt="Thumbnail" 
                                 class="img-fluid rounded" 
                                 style="max-width: 100%; max-height: 300px; border: 3px solid #ddd; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                                 onclick="showThumbnailFullscreen(this.src)"
                                 onerror="this.style.display='none'; document.getElementById('thumbnailError').style.display='block';">
                            <p id="thumbnailError" style="display: none; color: #e74c3c; padding: 15px; background: #fee; border-radius: 5px; margin-top: 10px;">
                                ‚ö†Ô∏è Erro ao carregar thumbnail. O YouTube usar√° thumbnail autom√°tico.
                            </p>
                        </div>
                        <div class="text-center mt-3">
                            <div class="form-check d-inline-flex align-items-center p-2 bg-success bg-opacity-10 rounded border border-success">
                                <input class="form-check-input me-2" type="checkbox" id="useThumbnail" checked style="width: 20px; height: 20px;">
                                <label class="form-check-label fw-bold text-success" for="useThumbnail" style="cursor: pointer;">
                                    ‚úÖ Usar este thumbnail ao publicar
                                </label>
                            </div>
                        </div>
                        <small class="text-muted d-block text-center mt-2">
                            üí° Clique na imagem para ver em tamanho real
                        </small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">T√≠tulo:</label>
                        <input type="text" class="form-control" id="aiResultTitle" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Descri√ß√£o:</label>
                        <textarea class="form-control" id="aiResultDescription" rows="4" readonly></textarea>
                    </div>
                    <div class="alert alert-info">
                        <small>Este conte√∫do foi gerado automaticamente. Voc√™ pode edit√°-lo antes de agendar ou publicar.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-success" onclick="useAIContentAndPublish()">Usar e Publicar</button>
                    <button type="button" class="btn btn-primary" onclick="useAIContent()">Usar e Agendar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para ver thumbnail em tamanho real -->
    <div class="modal fade" id="thumbnailFullscreenModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thumbnail</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="fullscreenThumbnail" src="" alt="Thumbnail" class="img-fluid">
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Agendar -->
    <div class="modal fade" id="scheduleModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">üìÖ Agendar V√≠deo</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="scheduleVideoPath">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Data e Hora de Publica√ß√£o</label>
                        <input type="datetime-local" class="form-control" id="scheduleDateTime" required>
                        <small class="text-muted">Selecione quando o v√≠deo deve ser publicado</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">T√≠tulo do V√≠deo</label>
                        <input type="text" class="form-control" id="scheduleTitle" required maxlength="100">
                        <small class="text-muted">M√°ximo 100 caracteres</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Descri√ß√£o</label>
                        <textarea class="form-control" id="scheduleDescription" rows="5" maxlength="5000">#shorts</textarea>
                        <small class="text-muted">M√°ximo 5000 caracteres</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="confirmSchedule()">
                        <span id="scheduleBtnText">üìÖ Agendar</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Publicar -->
    <div class="modal fade" id="publishModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">üöÄ Publicar V√≠deo Agora</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="publishVideoPath">
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è Aten√ß√£o:</strong> O v√≠deo ser√° publicado imediatamente no YouTube ap√≥s confirmar.
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">T√≠tulo do V√≠deo</label>
                        <input type="text" class="form-control" id="publishTitle" required maxlength="100">
                        <small class="text-muted">M√°ximo 100 caracteres</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Descri√ß√£o</label>
                        <textarea class="form-control" id="publishDescription" rows="5" maxlength="5000">#shorts</textarea>
                        <small class="text-muted">M√°ximo 5000 caracteres</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="confirmPublish()">
                        <span id="publishBtnText">üöÄ Publicar Agora</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentVideos = [];

        // Quando selecionar pasta via input
        document.getElementById('folderInput').addEventListener('change', function(e) {
            console.log('üìÇ ===== PASTA SELECIONADA VIA INPUT =====');
            const files = Array.from(e.target.files);
            console.log('üìÅ Total de arquivos selecionados:', files.length);
            
            const videoExtensions = ['.mp4', '.avi', '.mov', '.mkv', '.webm', '.flv', '.wmv'];
            
            // Extrair pasta base do primeiro arquivo (webkitRelativePath cont√©m o caminho relativo)
            let baseFolder = null;
            if (files.length > 0 && files[0].webkitRelativePath) {
                // webkitRelativePath √© algo como "videos/Filmes e S√©ries (13).mp4"
                // Extrair a pasta base (tudo antes do √∫ltimo "/")
                const relativePath = files[0].webkitRelativePath;
                const lastSlash = relativePath.lastIndexOf('/');
                if (lastSlash > 0) {
                    baseFolder = relativePath.substring(0, lastSlash);
                    console.log('üìÅ Pasta base detectada:', baseFolder);
                }
            }
            
            // Filtrar APENAS v√≠deos (ignorar screenshots, imagens, etc)
            const videos = files
                .filter(file => {
                    const fileName = file.name.toLowerCase();
                    const ext = '.' + fileName.split('.').pop();
                    
                    // Verificar extens√£o de v√≠deo
                    const isVideo = videoExtensions.includes(ext);
                    
                    // Rejeitar explicitamente imagens/screenshots
                    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp', '.svg', '.ico'];
                    const isImage = imageExtensions.includes(ext);
                    
                    // Rejeitar arquivos que parecem ser screenshots
                    const isScreenshot = fileName.includes('screenshot') || 
                                        fileName.includes('captura') || 
                                        fileName.includes('screen') ||
                                        fileName.startsWith('img_') ||
                                        fileName.startsWith('photo_');
                    
                    if (isImage || isScreenshot) {
                        console.log(`   ‚è≠Ô∏è  Ignorando arquivo (n√£o √© v√≠deo): ${file.name}`);
                        return false;
                    }
                    
                    return isVideo;
                })
                .map(file => {
                    const videoName = file.name;
                    return {
                        name: videoName,
                        path: videoName,
                        size: file.size,
                        sizeMB: (file.size / (1024 * 1024)).toFixed(2),
                        file: file // Guardar o arquivo para uso posterior
                    };
                });

            console.log('üìπ V√≠deos encontrados:', videos.length, 'de', files.length, 'arquivos totais');
            if (videos.length > 0) {
                videos.forEach((video, idx) => {
                    console.log(`   ${idx + 1}. ${video.name} (${video.sizeMB} MB)`);
                });
            } else {
                console.warn('‚ö†Ô∏è  Nenhum v√≠deo encontrado nesta pasta');
                console.warn('   Total de arquivos na pasta:', files.length);
                console.warn('   Extens√µes encontradas:', [...new Set(files.map(f => '.' + f.name.split('.').pop().toLowerCase()))].join(', '));
            }

            if (videos.length === 0) {
                alert(`Nenhum v√≠deo encontrado nesta pasta.\n\nTotal de arquivos: ${files.length}\n\nCertifique-se de que a pasta cont√©m arquivos de v√≠deo (.mp4, .avi, .mov, etc).`);
                return;
            }

            currentVideos = videos;
            displayVideos(videos);
            console.log('‚úÖ ===== V√çDEOS LISTADOS COM SUCESSO =====');
        });

        // Fun√ß√£o para carregar pasta padr√£o
        async function loadDefaultFolder() {
            // Pegar o valor do campo manual (que j√° est√° preenchido com a pasta padr√£o)
            const defaultFolder = document.getElementById('folderPath').value.trim();
            
            if (!defaultFolder) {
                alert('Nenhuma pasta padr√£o configurada');
                return;
            }

            // Escanear pasta
            document.getElementById('loading').style.display = 'block';
            document.getElementById('videosList').style.display = 'none';

            try {
                const response = await fetch('/user/videos/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ folderPath: defaultFolder })
                });

                const data = await response.json();
                document.getElementById('loading').style.display = 'none';

                if (data.success) {
                    currentVideos = data.videos;
                    displayVideos(data.videos);
                } else {
                    alert('Erro: ' + data.error);
                }
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                alert('Erro ao carregar pasta: ' + error.message);
            }
        }

        // Carregar pasta padr√£o ao carregar a p√°gina (opcional - comentado)
        // <% if (defaultFolder) { %>
        //     window.addEventListener('DOMContentLoaded', function() {
        //         // Preencher campo manual com a pasta padr√£o
        //         document.getElementById('folderPath').value = '<%= defaultFolder %>';
        //     });
        // <% } %>

        async function clearDefaultFolder() {
            if (confirm('Deseja remover a pasta padr√£o? Voc√™ precisar√° selecionar uma nova pasta.')) {
                try {
                    await fetch('/user/videos/save-folder', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ folderPath: '' })
                    });
                    location.reload();
                } catch (error) {
                    alert('Erro ao remover pasta padr√£o: ' + error.message);
                }
            }
        }

        function toggleManualPath() {
            const section = document.getElementById('manualPathSection');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }

        async function scanFolder() {
            const folderPath = document.getElementById('folderPath').value.trim();
            if (!folderPath) {
                alert('Digite o caminho da pasta');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('videosList').style.display = 'none';

            try {
                const response = await fetch('/user/videos/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ folderPath })
                });

                const data = await response.json();
                document.getElementById('loading').style.display = 'none';

                if (data.success) {
                    currentVideos = data.videos;
                    displayVideos(data.videos);
                    
                    // Salvar pasta como padr√£o
                    try {
                        const saveResponse = await fetch('/user/videos/save-folder', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ folderPath })
                        });
                        
                        const saveData = await saveResponse.json();
                        if (saveData.success) {
                            console.log('‚úÖ Pasta salva como padr√£o:', folderPath);
                        } else {
                            console.error('Erro ao salvar pasta:', saveData.error);
                        }
                    } catch (error) {
                        console.error('Erro ao salvar pasta padr√£o:', error);
                    }
                } else {
                    alert('Erro: ' + data.error);
                }
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                alert('Erro ao escanear pasta: ' + error.message);
            }
        }

        function displayVideos(videos) {
            console.log('üìã ===== EXIBINDO V√çDEOS =====');
            console.log('üìä Total de v√≠deos para exibir:', videos.length);
            
            const container = document.getElementById('videosContainer');
            container.innerHTML = '';

            if (videos.length === 0) {
                console.warn('‚ö†Ô∏è  Nenhum v√≠deo para exibir');
                container.innerHTML = '<p class="text-muted">Nenhum v√≠deo encontrado nesta pasta.</p>';
                return;
            }

            videos.forEach((video, index) => {
                console.log(`   Criando card para: ${video.name}`);
                const card = document.createElement('div');
                card.className = 'card mb-3';
                card.innerHTML = `
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h6 class="mb-1">${escapeHtml(video.name)}</h6>
                                <small class="text-muted">${video.sizeMB} MB</small>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-sm btn-info" onclick="generateWithAI(${index})">
                                    ü§ñ Gerar com IA
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="openScheduleModal(${index})">
                                    üìÖ Agendar
                                </button>
                                <button class="btn btn-sm btn-success" onclick="openPublishModal(${index})">
                                    üöÄ Publicar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });

            document.getElementById('videosList').style.display = 'block';
            console.log('‚úÖ ===== V√çDEOS EXIBIDOS COM SUCESSO =====');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        let currentAIVideoIndex = null;

        function showThumbnailFullscreen(src) {
            document.getElementById('fullscreenThumbnail').src = src;
            new bootstrap.Modal(document.getElementById('thumbnailFullscreenModal')).show();
        }

        function useAIContent() {
            if (currentAIVideoIndex === null) return;
            
            const video = currentVideos[currentAIVideoIndex];
            if (!video || !video.generatedContent) return;

            // Verifica se deve usar o thumbnail (igual bot antigo)
            const useThumbnailCheckbox = document.getElementById('useThumbnail');
            const useThumbnail = useThumbnailCheckbox ? useThumbnailCheckbox.checked : false;
            const thumbnailUrl = video.generatedContent.thumbnailUrl || '';
            const thumbnailToUse = (useThumbnail && thumbnailUrl) ? thumbnailUrl : null;

            console.log('üì∏ Thumbnail info:', { useThumbnail, thumbnailUrl, thumbnailToUse });

            // Fechar modal de resultado
            bootstrap.Modal.getInstance(document.getElementById('aiResultModal')).hide();

            // Preencher modais de agendar e publicar com o conte√∫do gerado
            document.getElementById('scheduleTitle').value = video.generatedContent.title;
            document.getElementById('scheduleDescription').value = video.generatedContent.description;
            document.getElementById('publishTitle').value = video.generatedContent.title;
            document.getElementById('publishDescription').value = video.generatedContent.description;

            // Salvar thumbnail se existir (igual bot antigo)
            if (thumbnailToUse) {
                let thumbnailField = document.getElementById('schedule-thumbnail');
                if (!thumbnailField) {
                    const scheduleForm = document.querySelector('#scheduleModal form');
                    if (scheduleForm) {
                        thumbnailField = document.createElement('input');
                        thumbnailField.type = 'hidden';
                        thumbnailField.id = 'schedule-thumbnail';
                        scheduleForm.appendChild(thumbnailField);
                    }
                }
                if (thumbnailField) {
                    thumbnailField.value = thumbnailToUse;
                }
            }

            // Abrir modal de agendar
            new bootstrap.Modal(document.getElementById('scheduleModal')).show();
        }

        async function useAIContentAndPublish() {
            if (currentAIVideoIndex === null) return;
            
            const video = currentVideos[currentAIVideoIndex];
            if (!video || !video.generatedContent) return;

            // Verifica se deve usar o thumbnail (igual bot antigo)
            const useThumbnailCheckbox = document.getElementById('useThumbnail');
            const useThumbnail = useThumbnailCheckbox ? useThumbnailCheckbox.checked : false;
            const thumbnailUrl = video.generatedContent.thumbnailUrl || '';
            const thumbnailPath = video.generatedContent.thumbnail_path || '';
            const thumbnailToUse = (useThumbnail && thumbnailPath) ? thumbnailPath : null;

            console.log('üì∏ Thumbnail info (publish):', { useThumbnail, thumbnailUrl, thumbnailPath, thumbnailToUse });

            // Fechar modal de resultado
            bootstrap.Modal.getInstance(document.getElementById('aiResultModal')).hide();

            // Publicar diretamente sem abrir outro modal
            const title = video.generatedContent.title;
            const description = video.generatedContent.description;
            const videoPath = video.path;

            if (!title) {
                alert('T√≠tulo √© obrigat√≥rio');
                return;
            }

            // Mostrar loading
            const loadingToast = document.createElement('div');
            loadingToast.className = 'alert alert-info position-fixed top-0 start-50 translate-middle-x mt-3';
            loadingToast.style.zIndex = '9999';
            loadingToast.innerHTML = '‚è≥ Publicando v√≠deo com conte√∫do gerado pela IA...';
            document.body.appendChild(loadingToast);

            try {
                const response = await fetch('/user/videos/publish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        videoPath, 
                        title, 
                        description,
                        thumbnail_path: thumbnailToUse  // Enviar caminho do thumbnail
                    })
                });

                const data = await response.json();
                loadingToast.remove();

                if (data.success) {
                    // Mostrar mensagem de sucesso com link
                    const toast = document.createElement('div');
                    toast.className = 'alert alert-success position-fixed top-0 start-50 translate-middle-x mt-3';
                    toast.style.zIndex = '9999';
                    toast.style.maxWidth = '500px';
                    toast.innerHTML = `
                        <strong>‚úÖ V√≠deo publicado com sucesso!</strong><br>
                        <a href="${data.videoUrl}" target="_blank" class="alert-link">Ver no YouTube ‚Üí</a>
                    `;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 5000);
                } else {
                    alert('Erro: ' + data.error);
                }
            } catch (error) {
                loadingToast.remove();
                alert('Erro: ' + error.message);
            }
        }

        async function generateWithAI(index) {
            const video = currentVideos[index];
            if (!video) return;

            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Gerando...';

            console.log('üé¨ ===== INICIANDO GERA√á√ÉO DE CONTE√öDO COM IA =====');
            console.log('üìπ V√≠deo selecionado:', video.name);
            console.log('üìÅ Caminho:', video.path);

            try {
                let videoPath = video.path;
                
                // Se o v√≠deo tem um objeto File (foi selecionado via input), fazer upload primeiro
                if (video.file && video.file instanceof File) {
                    console.log('üì§ V√≠deo selecionado via input, fazendo upload...');
                    console.log('üìä Tamanho do arquivo:', (video.file.size / (1024 * 1024)).toFixed(2), 'MB');
                    btn.textContent = '‚è≥ Enviando v√≠deo...';
                    
                    const formData = new FormData();
                    formData.append('video', video.file);
                    
                    const uploadStartTime = Date.now();
                    const uploadResponse = await fetch('/user/videos/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const uploadData = await uploadResponse.json();
                    const uploadDuration = ((Date.now() - uploadStartTime) / 1000).toFixed(2);
                    
                    if (!uploadData.success) {
                        console.error('‚ùå Erro no upload:', uploadData.error);
                        throw new Error(uploadData.error || 'Erro ao fazer upload do v√≠deo');
                    }
                    
                    // Usar o caminho retornado pelo upload
                    videoPath = uploadData.videoPath;
                    console.log('‚úÖ V√≠deo enviado com sucesso em', uploadDuration, 'segundos');
                    console.log('üìÅ Caminho no servidor:', videoPath);
                    
                    // Atualizar o caminho no objeto do v√≠deo para pr√≥ximas opera√ß√µes
                    currentVideos[index].path = videoPath;
                    currentVideos[index].file = null; // Limpar refer√™ncia ao arquivo
                }

                console.log('ü§ñ Iniciando gera√ß√£o de conte√∫do com Gemini...');
                console.log('üì∏ Extraindo frames do v√≠deo...');
                btn.textContent = '‚è≥ Gerando conte√∫do...';
                
                // Timeout de 10 minutos (600 segundos)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 600000);
                
                console.log('üì§ Enviando requisi√ß√£o para o servidor...');
                const generateStartTime = Date.now();
                
                const response = await fetch('/user/videos/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ videoPath }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                const generateDuration = ((Date.now() - generateStartTime) / 1000).toFixed(2);
                console.log('‚è±Ô∏è  Tempo de processamento:', generateDuration, 'segundos');
                
                // Verificar se a resposta √© JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('‚ùå Resposta n√£o √© JSON:', text.substring(0, 200));
                    throw new Error(`Erro do servidor (${response.status}): ${text.substring(0, 100)}`);
                }
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Erro HTTP:', response.status);
                    console.error('üìù Detalhes do erro:', errorText.substring(0, 200));
                    throw new Error(`Erro ${response.status}: ${errorText.substring(0, 200)}`);
                }
                
                const data = await response.json();
                
                console.log('‚úÖ Resposta recebida do servidor!');
                console.log('üì¶ Dados recebidos:', {
                    success: data.success,
                    title: data.title,
                    description: data.description,
                    thumbnail_path: data.thumbnail_path
                });
                
                btn.disabled = false;
                btn.textContent = 'ü§ñ Gerar com IA';

                if (data.success) {
                        console.log('‚úÖ ===== CONTE√öDO GERADO COM SUCESSO =====');
                        console.log('üìù T√≠tulo gerado:', data.title);
                        console.log('üìÑ Descri√ß√£o gerada:', data.description);
                        console.log('üì∏ Thumbnail:', data.thumbnail_path || 'N/A');
                    
                        // Guardar conte√∫do gerado no v√≠deo (mesmo formato do bot antigo)
                        const generatedContent = {
                            title: data.title,
                            description: data.description,
                            thumbnail_path: data.thumbnail_path
                        };
                        currentVideos[index].generatedContent = generatedContent;
                        currentAIVideoIndex = index;
                        
                        // Preencher modal de resultado
                        document.getElementById('aiResultTitle').value = data.title || '';
                        document.getElementById('aiResultDescription').value = data.description || '';
                        
                        // Processar thumbnail - usar diretamente a URL retornada pelo backend
                        const thumbnailSection = document.getElementById('thumbnailSection');
                        let thumbnailUrl = '';
                        
                        console.log('üîç Verificando thumbnail_path:', data.thumbnail_path);
                        
                        if (data.thumbnail_path) {
                            // O backend j√° retorna a URL relativa correta (/thumbnails/nome_arquivo.jpg)
                            // N√£o precisa reconstruir, usar diretamente
                            thumbnailUrl = data.thumbnail_path;
                            
                            console.log('üì∏ Thumbnail encontrado!');
                            console.log('   Caminho:', data.thumbnail_path);
                            console.log('   URL:', thumbnailUrl);
                            
                            // Mostrar thumbnail
                            const thumbnailImg = document.getElementById('aiResultThumbnail');
                            if (thumbnailImg) {
                                // Limpar src anterior para for√ßar recarregamento
                                thumbnailImg.src = '';
                                
                                // Configurar handlers ANTES de definir o src
                                thumbnailImg.onerror = function() {
                                    console.error('‚ùå Erro ao carregar thumbnail no navegador');
                                    console.error('   URL tentada:', this.src);
                                    this.style.display = 'none';
                                    const errorMsg = document.getElementById('thumbnailError');
                                    if (errorMsg) errorMsg.style.display = 'block';
                                };
                                
                                thumbnailImg.onload = function() {
                                    console.log('‚úÖ Thumbnail carregado com sucesso no navegador!');
                                    console.log('   URL final:', this.src);
                                    this.style.display = 'block';
                                    const errorMsg = document.getElementById('thumbnailError');
                                    if (errorMsg) errorMsg.style.display = 'none';
                                };
                                
                                // Definir src com timestamp para evitar cache
                                thumbnailImg.src = thumbnailUrl + '?t=' + Date.now();
                                thumbnailImg.style.display = 'block';
                            }
                            
                            thumbnailSection.style.display = 'block';
                            
                            // Guardar URL do thumbnail
                            currentVideos[index].generatedContent.thumbnailUrl = thumbnailUrl;
                            currentVideos[index].generatedContent.thumbnail_path = data.thumbnail_path;
                        } else {
                            console.warn('‚ö†Ô∏è  Nenhum thumbnail retornado pelo servidor');
                            console.warn('   thumbnail_path:', data.thumbnail_path);
                            thumbnailSection.style.display = 'none';
                        }
                        
                        console.log('üéâ ===== GERA√á√ÉO CONCLU√çDA =====');
                        console.log('üìä Resumo:');
                        console.log('   - T√≠tulo:', data.title);
                        console.log('   - Descri√ß√£o:', data.description);
                        console.log('   - Thumbnail:', data.thumbnail_path ? 'Sim' : 'N√£o');
                        console.log('   - Tempo total:', generateDuration, 'segundos');
                        
                        // Mostrar modal
                        new bootstrap.Modal(document.getElementById('aiResultModal')).show();
                } else {
                    // Mostrar erro em modal tamb√©m
                    const errorModal = document.createElement('div');
                    errorModal.className = 'modal fade';
                    errorModal.innerHTML = `
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header bg-danger text-white">
                                    <h5 class="modal-title">‚ùå Erro</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <p>${data.error}</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(errorModal);
                    const bsModal = new bootstrap.Modal(errorModal);
                    bsModal.show();
                    errorModal.addEventListener('hidden.bs.modal', () => errorModal.remove());
                }
            } catch (error) {
                clearTimeout(timeoutId);
                btn.disabled = false;
                btn.textContent = 'ü§ñ Gerar com IA';
                
                console.error('‚ùå ===== ERRO NA GERA√á√ÉO DE CONTE√öDO =====');
                console.error('‚ùå Tipo de erro:', error.name);
                console.error('‚ùå Mensagem:', error.message);
                console.error('‚ùå Stack:', error.stack);
                
                let errorMessage = 'Erro ao gerar conte√∫do';
                if (error.name === 'AbortError') {
                    errorMessage = 'Tempo de espera excedido. O processamento est√° demorando muito. Tente novamente.';
                    console.error('‚è±Ô∏è  Timeout: O processamento demorou mais de 10 minutos');
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                console.error('‚ùå ===== FIM DO ERRO =====');
                alert('Erro: ' + errorMessage);
            }
        }

        function openScheduleModal(index) {
            const video = currentVideos[index];
            if (!video) return;

            // Se j√° tem conte√∫do gerado, usar ele
            const title = video.generatedContent?.title || video.name.replace(/\.[^/.]+$/, '').replace(/[()]/g, ' ').trim();
            const description = video.generatedContent?.description || '#shorts';

            document.getElementById('scheduleVideoPath').value = video.path;
            document.getElementById('scheduleTitle').value = title;
            document.getElementById('scheduleDescription').value = description;
            
            // Data/hora padr√£o: 1 hora a partir de agora
            const now = new Date();
            now.setHours(now.getHours() + 1);
            const dateStr = now.toISOString().slice(0, 16);
            document.getElementById('scheduleDateTime').value = dateStr;

            // Guardar √≠ndice do v√≠deo
            document.getElementById('scheduleModal').dataset.videoIndex = index;

            new bootstrap.Modal(document.getElementById('scheduleModal')).show();
        }

        function openPublishModal(index) {
            const video = currentVideos[index];
            if (!video) return;

            // Se j√° tem conte√∫do gerado, usar ele
            const title = video.generatedContent?.title || video.name.replace(/\.[^/.]+$/, '').replace(/[()]/g, ' ').trim();
            const description = video.generatedContent?.description || '#shorts';

            document.getElementById('publishVideoPath').value = video.path;
            document.getElementById('publishTitle').value = title;
            document.getElementById('publishDescription').value = description;

            // Guardar √≠ndice do v√≠deo
            document.getElementById('publishModal').dataset.videoIndex = index;

            new bootstrap.Modal(document.getElementById('publishModal')).show();
        }

        async function confirmSchedule() {
            const index = parseInt(document.getElementById('scheduleModal').dataset.videoIndex);
            const video = currentVideos[index];
            if (!video) return;

            const scheduledTime = document.getElementById('scheduleDateTime').value;
            const title = document.getElementById('scheduleTitle').value;
            const description = document.getElementById('scheduleDescription').value;

            if (!scheduledTime || !title) {
                alert('Preencha todos os campos obrigat√≥rios');
                return;
            }

            // Usar o caminho do v√≠deo (j√° est√° no servidor quando vem do scan)
            const videoPath = video.path;

            const btn = document.querySelector('#scheduleModal .btn-primary');
            btn.disabled = true;
            document.getElementById('scheduleBtnText').textContent = '‚è≥ Agendando...';

            try {
                const response = await fetch('/user/videos/schedule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ videoPath, scheduledTime, title, description })
                });

                const data = await response.json();
                btn.disabled = false;
                document.getElementById('scheduleBtnText').textContent = 'üìÖ Agendar';

                if (data.success) {
                    // Fechar modal
                    bootstrap.Modal.getInstance(document.getElementById('scheduleModal')).hide();
                    
                    // Mostrar mensagem de sucesso
                    const toast = document.createElement('div');
                    toast.className = 'alert alert-success position-fixed top-0 start-50 translate-middle-x mt-3';
                    toast.style.zIndex = '9999';
                    toast.innerHTML = '‚úÖ V√≠deo agendado com sucesso! Verifique na p√°gina "Agendados".';
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 4000);
                } else {
                    alert('Erro: ' + data.error);
                }
            } catch (error) {
                btn.disabled = false;
                btn.textContent = 'Agendar';
                alert('Erro: ' + error.message);
            }
        }

        async function confirmPublish() {
            const index = parseInt(document.getElementById('publishModal').dataset.videoIndex);
            const video = currentVideos[index];
            if (!video) return;

            const title = document.getElementById('publishTitle').value;
            const description = document.getElementById('publishDescription').value;

            if (!title) {
                alert('Preencha o t√≠tulo');
                return;
            }

            // Usar o caminho do v√≠deo (j√° est√° no servidor quando vem do scan)
            const videoPath = video.path;

            // Verificar se tem thumbnail do conte√∫do gerado
            let thumbnailPath = null;
            if (video.generatedContent && video.generatedContent.thumbnail_path) {
                // Verificar se checkbox est√° marcado (se existir)
                const useThumbnailCheckbox = document.getElementById('useThumbnail');
                const useThumbnail = useThumbnailCheckbox ? useThumbnailCheckbox.checked : true; // Default true
                if (useThumbnail) {
                    thumbnailPath = video.generatedContent.thumbnail_path;
                }
            }

            const btn = document.querySelector('#publishModal .btn-success');
            btn.disabled = true;
            document.getElementById('publishBtnText').textContent = '‚è≥ Publicando...';

            try {
                const response = await fetch('/user/videos/publish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        videoPath, 
                        title, 
                        description,
                        thumbnail_path: thumbnailPath  // Enviar caminho do thumbnail
                    })
                });

                const data = await response.json();
                btn.disabled = false;
                document.getElementById('publishBtnText').textContent = 'üöÄ Publicar Agora';

                if (data.success) {
                    // Fechar modal
                    bootstrap.Modal.getInstance(document.getElementById('publishModal')).hide();
                    
                    // Mostrar mensagem de sucesso com link
                    const toast = document.createElement('div');
                    toast.className = 'alert alert-success position-fixed top-0 start-50 translate-middle-x mt-3';
                    toast.style.zIndex = '9999';
                    toast.style.maxWidth = '500px';
                    toast.innerHTML = `
                        <strong>‚úÖ V√≠deo publicado com sucesso!</strong><br>
                        <a href="${data.videoUrl}" target="_blank" class="alert-link">Ver no YouTube ‚Üí</a>
                    `;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 5000);
                } else {
                    alert('Erro: ' + data.error);
                }
            } catch (error) {
                btn.disabled = false;
                btn.textContent = 'üöÄ Publicar Agora';
                alert('Erro: ' + error.message);
            }
        }
    </script>
</body>
</html>

