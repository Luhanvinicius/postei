<%- include('../layouts/main', { title: 'Gerenciar V√≠deos', user: user, body: `
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">üé¨ Gerenciar V√≠deos</h1>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">üìÅ Selecionar Pasta</h5>
                <% if (defaultFolder) { %>
                    <div class="alert alert-info d-flex align-items-center justify-content-between">
                        <div>
                            <strong>Pasta padr√£o:</strong> <%= defaultFolder %>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-primary ms-2" onclick="loadDefaultFolder()">üìÇ Carregar V√≠deos</button>
                            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="clearDefaultFolder()">Alterar</button>
                        </div>
                    </div>
                <% } %>
                <div class="mb-3" id="manualPathSection" style="<%= defaultFolder ? 'display: none;' : 'display: block;' %>">
                    <label for="folderPath" class="form-label">Digite o caminho da pasta que cont√©m os v√≠deos:</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="folderPath" placeholder="Caminho da pasta (ex: F:\isauro\videos)" value="<%= defaultFolder ? defaultFolder.replace(/\\/g, '\\\\') : '' %>">
                        <button class="btn btn-secondary" onclick="scanFolder()">Escanear Pasta</button>
                    </div>
                    <small class="text-muted">Ex: C:\Users\SeuUsuario\Videos\MeusShorts</small>
                </div>
                <% if (!defaultFolder) { %>
                    <button type="button" class="btn btn-link p-0" onclick="toggleManualPath()">
                        <small>Ou selecione a pasta via explorador de arquivos</small>
                    </button>
                    <div class="mb-3 mt-2" id="fileInputSection" style="display: none;">
                        <label for="folderInput" class="form-label">Escolha a pasta que cont√©m os v√≠deos:</label>
                        <input type="file" class="form-control" id="folderInput" webkitdirectory directory multiple>
                        <small class="text-muted">O navegador pode mostrar um aviso sobre muitos arquivos, mas apenas v√≠deos ser√£o processados.</small>
                    </div>
                <% } %>
            </div>
        </div>
    </div>
</div>

<div id="videosList" class="row" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">üìπ V√≠deos Encontrados</h5>
                <div id="videosContainer"></div>
            </div>
        </div>
    </div>
</div>

<div id="loading" class="text-center" style="display: none;">
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Carregando...</span>
    </div>
</div>

<!-- Modal para Resultado da IA -->
<div class="modal fade" id="aiResultModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">ü§ñ Conte√∫do Gerado com IA</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3" id="thumbnailSection" style="display: none;">
                    <label class="form-label fw-bold">üì∏ Thumbnail Gerado:</label>
                    <div class="text-center mb-2 p-3 bg-light rounded" style="border: 2px solid #dee2e6;">
                        <img id="aiResultThumbnail" src="" alt="Thumbnail" 
                             class="img-fluid rounded" 
                             style="max-width: 100%; max-height: 300px; border: 3px solid #ddd; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                             onclick="showThumbnailFullscreen(this.src)">
                        <p id="thumbnailError" class="text-danger mt-2" style="display: none;">‚ö†Ô∏è Thumbnail n√£o foi gerado ou n√£o p√¥de ser carregado</p>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="useThumbnail" checked>
                        <label class="form-check-label" for="useThumbnail">
                            Usar este thumbnail ao publicar
                        </label>
                    </div>
                    <small class="text-muted">Clique na imagem para ver em tamanho real</small>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">T√≠tulo:</label>
                    <input type="text" class="form-control" id="aiResultTitle" maxlength="100">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Descri√ß√£o:</label>
                    <textarea class="form-control" id="aiResultDescription" rows="5" maxlength="5000"></textarea>
                </div>
                <div class="alert alert-info mt-3">
                    Este conte√∫do foi gerado automaticamente. Voc√™ pode edit√°-lo antes de agendar ou publicar.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-success" onclick="useAIContentAndPublish()">Usar e Publicar</button>
                <button type="button" class="btn btn-primary" onclick="useAIContentAndSchedule()">Usar e Agendar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Agendar V√≠deo -->
<div class="modal fade" id="scheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">üìÖ Agendar V√≠deo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="scheduleVideoPath">
                <div class="mb-3">
                    <label class="form-label fw-bold">T√≠tulo do V√≠deo</label>
                    <input type="text" class="form-control" id="scheduleTitle" required maxlength="100">
                    <small class="text-muted">M√°ximo 100 caracteres</small>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Descri√ß√£o</label>
                    <textarea class="form-control" id="scheduleDescription" rows="5" maxlength="5000">#shorts</textarea>
                    <small class="text-muted">M√°ximo 5000 caracteres</small>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Data e Hora de Agendamento</label>
                    <input type="datetime-local" class="form-control" id="scheduleDateTime" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="scheduleVideo()">Agendar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Publicar V√≠deo -->
<div class="modal fade" id="publishModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">üöÄ Publicar V√≠deo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="publishVideoPath">
                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Aten√ß√£o:</strong> O v√≠deo ser√° publicado imediatamente no YouTube ap√≥s confirmar.
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">T√≠tulo do V√≠deo</label>
                    <input type="text" class="form-control" id="publishTitle" required maxlength="100">
                    <small class="text-muted">M√°ximo 100 caracteres</small>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Descri√ß√£o</label>
                    <textarea class="form-control" id="publishDescription" rows="5" maxlength="5000">#shorts</textarea>
                    <small class="text-muted">M√°ximo 5000 caracteres</small>
                </div>
                <div class="mb-3" id="publishThumbnailPreviewSection" style="display: none;">
                    <label class="form-label fw-bold">üì∏ Thumbnail a ser usado:</label>
                    <div class="text-center mb-2 p-3 bg-light rounded" style="border: 2px solid #dee2e6;">
                        <img id="publishThumbnailPreview" src="" alt="Thumbnail" 
                             class="img-fluid rounded" 
                             style="max-width: 100%; max-height: 200px; border: 3px solid #ddd; border-radius: 8px; cursor: pointer;"
                             onclick="showThumbnailFullscreen(this.src)">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="publishVideo()">
                    <span id="publishBtnText">üöÄ Publicar Agora</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Fullscreen Thumbnail -->
<div class="modal fade" id="thumbnailFullscreenModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content bg-transparent border-0">
            <div class="modal-body p-0 text-center">
                <img id="fullscreenThumbnail" src="" class="img-fluid" alt="Thumbnail em tela cheia" style="max-height: 90vh;">
            </div>
        </div>
    </div>
</div>

<script>
    let currentVideos = [];
    const videoExtensions = ['.mp4', '.avi', '.mov', '.mkv', '.webm', '.flv', '.wmv'];
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];

    // Fun√ß√£o para alternar entre input manual e sele√ß√£o de arquivo
    function toggleManualPath() {
        const manualSection = document.getElementById('manualPathSection');
        const fileInputSection = document.getElementById('fileInputSection');
        const toggleButton = document.querySelector('button[onclick="toggleManualPath()"] small');

        if (manualSection.style.display === 'none') {
            manualSection.style.display = 'block';
            fileInputSection.style.display = 'none';
            toggleButton.textContent = 'Ou selecione a pasta via explorador de arquivos';
        } else {
            manualSection.style.display = 'none';
            fileInputSection.style.display = 'block';
            toggleButton.textContent = 'Ou digite o caminho manualmente';
        }
    }

    // Quando selecionar pasta via input
    document.getElementById('folderInput')?.addEventListener('change', function(e) {
        console.log('üìÇ ===== PASTA SELECIONADA VIA INPUT =====');
        const files = Array.from(e.target.files);
        console.log('üìÅ Total de arquivos selecionados pelo navegador:', files.length);
        
        const filteredVideos = files
            .filter(file => {
                const ext = '.' + file.name.split('.').pop().toLowerCase();
                const isVideo = videoExtensions.includes(ext);
                const isImage = imageExtensions.includes(ext);
                
                if (isImage || file.name.toLowerCase().includes('screenshot') || file.name.toLowerCase().includes('captura de tela')) {
                    console.log(`   Ignorando arquivo (n√£o √© v√≠deo ou √© screenshot): ${file.name}`);
                    return false;
                }
                return isVideo;
            })
            .map(file => {
                const videoName = file.name;
                return {
                    name: videoName,
                    path: videoName,
                    size: file.size,
                    sizeMB: (file.size / (1024 * 1024)).toFixed(2),
                    file: file
                };
            });

        console.log('üìπ V√≠deos v√°lidos encontrados ap√≥s filtro:', filteredVideos.length);
        filteredVideos.forEach((video, idx) => {
            console.log(`   ${idx + 1}. ${video.name} (${video.sizeMB} MB)`);
        });

        if (filteredVideos.length === 0) {
            console.warn('‚ö†Ô∏è  Nenhum v√≠deo v√°lido encontrado nesta pasta ap√≥s o filtro.');
            alert('Nenhum v√≠deo v√°lido encontrado nesta pasta. Certifique-se de que a pasta cont√©m arquivos de v√≠deo (mp4, mov, etc.) e n√£o apenas imagens ou screenshots.');
            currentVideos = [];
            document.getElementById('videosList').style.display = 'none';
            return;
        }

        currentVideos = filteredVideos;
        displayVideos(filteredVideos);
        console.log('‚úÖ ===== V√çDEOS LISTADOS COM SUCESSO =====');
    });

    // Fun√ß√£o para carregar pasta padr√£o
    async function loadDefaultFolder() {
        console.log('üîÑ ===== CARREGANDO PASTA PADR√ÉO =====');
        const defaultFolder = document.getElementById('folderPath').value.trim();
        
        if (!defaultFolder) {
            alert('Nenhuma pasta padr√£o configurada');
            return;
        }

        document.getElementById('loading').style.display = 'block';
        document.getElementById('videosList').style.display = 'none';

        try {
            console.log('üì§ Enviando requisi√ß√£o para escanear pasta:', defaultFolder);
            const response = await fetch('/user/videos/scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ folderPath: defaultFolder })
            });

            const data = await response.json();
            document.getElementById('loading').style.display = 'none';

            if (data.success) {
                console.log('‚úÖ Pasta escaneada com sucesso!');
                console.log('üìπ V√≠deos encontrados:', data.videos.length);
                
                // Filtrar v√≠deos j√° publicados
                const publishedVideos = await getPublishedVideos();
                const filteredVideos = data.videos.filter(video => {
                    const isPublished = publishedVideos.some(pubVideo => pubVideo.video_path === video.path);
                    if (isPublished) {
                        console.log(`   Ignorando v√≠deo j√° publicado: ${video.name}`);
                    }
                    return !isPublished;
                });

                if (filteredVideos.length === 0) {
                    alert('Nenhum v√≠deo novo encontrado nesta pasta (todos j√° foram publicados ou n√£o s√£o v√≠deos v√°lidos).');
                    currentVideos = [];
                    document.getElementById('videosList').style.display = 'none';
                    return;
                }

                currentVideos = filteredVideos;
                displayVideos(filteredVideos);
            } else {
                console.error('‚ùå Erro ao escanear pasta:', data.error);
                alert('Erro: ' + data.error);
            }
        } catch (error) {
            document.getElementById('loading').style.display = 'none';
            console.error('‚ùå Erro de rede ao escanear pasta:', error);
            alert('Erro ao escanear pasta: ' + error.message);
        }
    }

    // Fun√ß√£o para remover pasta padr√£o
    async function clearDefaultFolder() {
        if (!confirm('Tem certeza que deseja remover a pasta padr√£o?')) {
            return;
        }
        try {
            const response = await fetch('/user/videos/save-folder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ folderPath: '' })
            });
            const data = await response.json();
            if (data.success) {
                alert('Pasta padr√£o removida com sucesso!');
                window.location.reload();
            } else {
                alert('Erro ao remover pasta padr√£o: ' + data.error);
            }
        } catch (error) {
            alert('Erro ao remover pasta padr√£o: ' + error.message);
        }
    }

    // Fun√ß√£o para escanear pasta manualmente
    async function scanFolder() {
        console.log('üîÑ ===== ESCANEANDO PASTA MANUALMENTE =====');
        const folderPath = document.getElementById('folderPath').value.trim();
        if (!folderPath) {
            alert('Digite o caminho da pasta');
            return;
        }

        document.getElementById('loading').style.display = 'block';
        document.getElementById('videosList').style.display = 'none';

        try {
            console.log('üì§ Enviando requisi√ß√£o para escanear pasta:', folderPath);
            const response = await fetch('/user/videos/scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ folderPath })
            });

            const data = await response.json();
            document.getElementById('loading').style.display = 'none';

            if (data.success) {
                console.log('‚úÖ Pasta escaneada com sucesso!');
                console.log('üìπ V√≠deos encontrados:', data.videos.length);
                
                // Filtrar v√≠deos j√° publicados
                const publishedVideos = await getPublishedVideos();
                const filteredVideos = data.videos.filter(video => {
                    const isPublished = publishedVideos.some(pubVideo => pubVideo.video_path === video.path);
                    if (isPublished) {
                        console.log(`   Ignorando v√≠deo j√° publicado: ${video.name}`);
                    }
                    return !isPublished;
                });

                if (filteredVideos.length === 0) {
                    alert('Nenhum v√≠deo novo encontrado nesta pasta (todos j√° foram publicados ou n√£o s√£o v√≠deos v√°lidos).');
                    currentVideos = [];
                    document.getElementById('videosList').style.display = 'none';
                    return;
                }

                currentVideos = filteredVideos;
                displayVideos(filteredVideos);
                
                // Salvar pasta como padr√£o
                try {
                    const saveResponse = await fetch('/user/videos/save-folder', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ folderPath })
                    });
                    
                    const saveData = await saveResponse.json();
                    if (saveData.success) {
                        console.log('‚úÖ Pasta salva como padr√£o:', folderPath);
                    } else {
                        console.error('Erro ao salvar pasta:', saveData.error);
                    }
                } catch (error) {
                    console.error('Erro ao salvar pasta padr√£o:', error);
                }
            } else {
                console.error('‚ùå Erro ao escanear pasta:', data.error);
                alert('Erro: ' + data.error);
            }
        } catch (error) {
            document.getElementById('loading').style.display = 'none';
            console.error('‚ùå Erro de rede ao escanear pasta:', error);
            alert('Erro ao escanear pasta: ' + error.message);
        }
    }

    // Fun√ß√£o para obter v√≠deos publicados (para filtrar)
    async function getPublishedVideos() {
        try {
            const response = await fetch('/user/published-videos-data');
            if (!response.ok) {
                throw new Error(\`HTTP error! status: \${response.status}\`);
            }
            const data = await response.json();
            return data.videos || [];
        } catch (error) {
            console.error('Erro ao buscar v√≠deos publicados para filtro:', error);
            return [];
        }
    }

    function displayVideos(videos) {
        console.log('üîÑ ===== EXIBINDO V√çDEOS =====');
        const container = document.getElementById('videosContainer');
        container.innerHTML = '';

        if (videos.length === 0) {
            console.warn('‚ö†Ô∏è  Nenhum v√≠deo para exibir');
            container.innerHTML = '<p class="text-muted">Nenhum v√≠deo encontrado nesta pasta.</p>';
            return;
        }

        videos.forEach((video, index) => {
            console.log(\`   Criando card para: \${video.name}\`);
            const card = document.createElement('div');
            card.className = 'card mb-3';
            card.innerHTML = \`
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h6 class="mb-1">\${escapeHtml(video.name)}</h6>
                            <small class="text-muted">\${video.sizeMB} MB</small>
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-sm btn-info" onclick="generateWithAI(\${index})">
                                ü§ñ Gerar com IA
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="openScheduleModal(\${index})">
                                üìÖ Agendar
                            </button>
                            <button class="btn btn-sm btn-success" onclick="openPublishModal(\${index})">
                                üöÄ Publicar
                            </button>
                        </div>
                    </div>
                </div>
            \`;
            container.appendChild(card);
        });

        document.getElementById('videosList').style.display = 'block';
        console.log('‚úÖ ===== V√çDEOS EXIBIDOS COM SUCESSO =====');
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    let currentAIVideoIndex = null;

    function showThumbnailFullscreen(src) {
        document.getElementById('fullscreenThumbnail').src = src;
        new bootstrap.Modal(document.getElementById('thumbnailFullscreenModal')).show();
    }

    async function useAIContentAndSchedule() {
        if (currentAIVideoIndex === null) return;
        
        const video = currentVideos[currentAIVideoIndex];
        if (!video || !video.generatedContent) return;

        // Preencher modal de agendar com o conte√∫do gerado
        document.getElementById('scheduleVideoPath').value = video.path;
        document.getElementById('scheduleTitle').value = video.generatedContent.title;
        document.getElementById('scheduleDescription').value = video.generatedContent.description;
        
        // Data/hora padr√£o: 1 hora a partir de agora
        const now = new Date();
        now.setHours(now.getHours() + 1);
        const year = now.getFullYear();
        const month = (now.getMonth() + 1).toString().padStart(2, '0');
        const day = now.getDate().toString().padStart(2, '0');
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        
        document.getElementById('scheduleDateTime').value = \`\${year}-\${month}-\${day}T\${hours}:\${minutes}\`;

        // Fechar modal de resultado
        bootstrap.Modal.getInstance(document.getElementById('aiResultModal')).hide();
        
        // Abrir modal de agendar
        new bootstrap.Modal(document.getElementById('scheduleModal')).show();
    }

    async function useAIContentAndPublish() {
        if (currentAIVideoIndex === null) return;
        
        const video = currentVideos[currentAIVideoIndex];
        if (!video || !video.generatedContent) return;

        // Publicar diretamente sem abrir outro modal
        const title = document.getElementById('aiResultTitle').value;
        const description = document.getElementById('aiResultDescription').value;
        const videoPath = video.path;
        const useGeneratedThumbnail = document.getElementById('useThumbnail').checked;
        const thumbnailPath = useGeneratedThumbnail ? (video.generatedContent?.thumbnail_path || null) : null;

        if (!title) {
            alert('T√≠tulo √© obrigat√≥rio');
            return;
        }

        // Mostrar loading
        const loadingToast = showLoadingToast('Publicando v√≠deo com conte√∫do gerado pela IA...');

        try {
            const response = await fetch('/user/videos/publish', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    videoPath, 
                    title, 
                    description,
                    thumbnail_path: thumbnailPath
                })
            });

            const data = await response.json();
            loadingToast.remove();

            if (data.success) {
                // Mostrar mensagem de sucesso com link
                const toast = document.createElement('div');
                toast.className = 'alert alert-success position-fixed top-0 start-50 translate-middle-x mt-3';
                toast.style.zIndex = '9999';
                toast.style.maxWidth = '500px';
                toast.innerHTML = \`
                    <strong>‚úÖ V√≠deo publicado com sucesso!</strong><br>
                    <a href="\${data.videoUrl}" target="_blank" class="alert-link">Ver no YouTube ‚Üí</a>
                \`;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 5000);
                
                // Fechar modal de resultado
                bootstrap.Modal.getInstance(document.getElementById('aiResultModal')).hide();
                
                // Recarregar a lista de v√≠deos para remover o publicado
                loadDefaultFolder();
            } else {
                alert('Erro: ' + data.error);
            }
        } catch (error) {
            loadingToast.remove();
            alert('Erro: ' + error.message);
        }
    }

    async function generateWithAI(index) {
        console.log('üé¨ ===== INICIANDO GERA√á√ÉO DE CONTE√öDO COM IA =====');
        const video = currentVideos[index];
        if (!video) {
            console.error('‚ùå V√≠deo n√£o encontrado para o √≠ndice:', index);
            return;
        }

        const btn = event.target;
        btn.disabled = true;
        btn.textContent = '‚è≥ Gerando...';

        console.log('üìπ V√≠deo selecionado:', video.name);
        console.log('üìÅ Caminho:', video.path);

        try {
            let videoPath = video.path;
            
            // Se o v√≠deo tem um objeto File (foi selecionado via input), fazer upload primeiro
            if (video.file && video.file instanceof File) {
                console.log('üì§ V√≠deo selecionado via input, fazendo upload...');
                console.log('üìä Tamanho do arquivo:', (video.file.size / (1024 * 1024)).toFixed(2), 'MB');
                btn.textContent = '‚è≥ Enviando v√≠deo...';
                
                const formData = new FormData();
                formData.append('video', video.file);
                
                const uploadStartTime = Date.now();
                const uploadResponse = await fetch('/user/videos/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const uploadData = await uploadResponse.json();
                const uploadDuration = ((Date.now() - uploadStartTime) / 1000).toFixed(2);
                
                if (!uploadData.success) {
                    console.error('‚ùå Erro no upload:', uploadData.error);
                    throw new Error(uploadData.error || 'Erro ao fazer upload do v√≠deo');
                }
                
                // Usar o caminho retornado pelo upload
                videoPath = uploadData.videoPath;
                console.log('‚úÖ V√≠deo enviado com sucesso em', uploadDuration, 'segundos');
                console.log('üìÅ Caminho no servidor:', videoPath);
                
                // Atualizar o caminho no objeto do v√≠deo para pr√≥ximas opera√ß√µes
                currentVideos[index].path = videoPath;
                currentVideos[index].file = null;
            }

            console.log('ü§ñ Iniciando gera√ß√£o de conte√∫do com Gemini...');
            console.log('üì∏ Extraindo frames do v√≠deo...');
            btn.textContent = '‚è≥ Gerando conte√∫do...';
            
            // Timeout de 10 minutos (600 segundos)
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 600000);
            
            console.log('üì§ Enviando requisi√ß√£o para o servidor...');
            const generateStartTime = Date.now();
            
            const response = await fetch('/user/videos/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ videoPath }),
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            const generateDuration = ((Date.now() - generateStartTime) / 1000).toFixed(2);
            console.log('‚è±Ô∏è  Tempo de processamento:', generateDuration, 'segundos');
            
            // Verificar se a resposta √© JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                console.error('‚ùå Resposta n√£o √© JSON:', text.substring(0, 200));
                throw new Error(\`Erro do servidor (\${response.status}): \${text.substring(0, 100)}\`);
            }
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('‚ùå Erro HTTP:', response.status);
                console.error('üìù Detalhes do erro:', errorText.substring(0, 200));
                throw new Error(\`Erro \${response.status}: \${errorText.substring(0, 200)}\`);
            }
            
            const data = await response.json();
            
            console.log('‚úÖ Resposta recebida do servidor!');
            console.log('üì¶ Dados recebidos:', {
                success: data.success,
                title: data.title,
                description: data.description,
                thumbnail_path: data.thumbnail_path
            });
            
            btn.disabled = false;
            btn.textContent = 'ü§ñ Gerar com IA';

            if (data.success) {
                console.log('‚úÖ ===== CONTE√öDO GERADO COM SUCESSO =====');
                console.log('üìù T√≠tulo gerado:', data.title);
                console.log('üìÑ Descri√ß√£o gerada:', data.description);
                console.log('üì∏ Thumbnail:', data.thumbnail_path || 'N/A');
            
                // Guardar conte√∫do gerado no v√≠deo
                const generatedContent = {
                    title: data.title,
                    description: data.description,
                    thumbnail_path: data.thumbnail_path
                };
                currentVideos[index].generatedContent = generatedContent;
                currentAIVideoIndex = index;
                
                // Preencher modal de resultado
                document.getElementById('aiResultTitle').value = data.title || '';
                document.getElementById('aiResultDescription').value = data.description || '';
                
                // Processar thumbnail
                const thumbnailSection = document.getElementById('thumbnailSection');
                let thumbnailUrl = '';
                
                console.log('üîç Verificando thumbnail_path:', data.thumbnail_path);
                
                if (data.thumbnail_path) {
                    thumbnailUrl = data.thumbnail_path;
                    
                    console.log('üì∏ Thumbnail encontrado!');
                    console.log('   Caminho:', data.thumbnail_path);
                    console.log('   URL:', thumbnailUrl);
                    
                    // Mostrar thumbnail
                    const thumbnailImg = document.getElementById('aiResultThumbnail');
                    if (thumbnailImg) {
                        thumbnailImg.src = '';
                        
                        thumbnailImg.onerror = function() {
                            console.error('‚ùå Erro ao carregar thumbnail:', thumbnailUrl);
                            this.style.display = 'none';
                            const errorMsg = document.getElementById('thumbnailError');
                            if (errorMsg) errorMsg.style.display = 'block';
                        };
                        
                        thumbnailImg.onload = function() {
                            console.log('‚úÖ Thumbnail carregado com sucesso:', thumbnailUrl);
                            this.style.display = 'block';
                            const errorMsg = document.getElementById('thumbnailError');
                            if (errorMsg) errorMsg.style.display = 'none';
                        };
                        
                        thumbnailImg.src = thumbnailUrl + '?t=' + Date.now();
                        thumbnailImg.style.display = 'block';
                    }
                    
                    thumbnailSection.style.display = 'block';
                    
                    currentVideos[index].generatedContent.thumbnailUrl = thumbnailUrl;
                    currentVideos[index].generatedContent.thumbnail_path = data.thumbnail_path;
                } else {
                    console.warn('‚ö†Ô∏è  Nenhum thumbnail retornado (thumbnail_path √© null ou vazio)');
                    thumbnailSection.style.display = 'none';
                }
                
                // Mostrar modal
                new bootstrap.Modal(document.getElementById('aiResultModal')).show();
            } else {
                // Mostrar erro em modal
                const errorModal = document.createElement('div');
                errorModal.className = 'modal fade';
                errorModal.innerHTML = \`
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title">‚ùå Erro</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>\${data.error}</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                            </div>
                        </div>
                    </div>
                \`;
                document.body.appendChild(errorModal);
                const bsModal = new bootstrap.Modal(errorModal);
                bsModal.show();
                errorModal.addEventListener('hidden.bs.modal', () => errorModal.remove());
            }
        } catch (error) {
            btn.disabled = false;
            btn.textContent = 'ü§ñ Gerar com IA';
            console.error('‚ùå Erro na gera√ß√£o de conte√∫do com IA:', error);
            // Mostrar erro em modal
            const errorModal = document.createElement('div');
            errorModal.className = 'modal fade';
            errorModal.innerHTML = \`
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title">‚ùå Erro</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p>\${error.message}</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            \`;
            document.body.appendChild(errorModal);
            const bsModal = new bootstrap.Modal(errorModal);
            bsModal.show();
            errorModal.addEventListener('hidden.bs.modal', () => errorModal.remove());
        }
    }

    function openScheduleModal(index) {
        const video = currentVideos[index];
        if (!video) return;

        // Se j√° tem conte√∫do gerado, usar ele
        const title = video.generatedContent?.title || video.name.replace(/\.[^/.]+$/, '').replace(/[()]/g, ' ').trim();
        const description = video.generatedContent?.description || '#shorts';

        document.getElementById('scheduleVideoPath').value = video.path;
        document.getElementById('scheduleTitle').value = title;
        document.getElementById('scheduleDescription').value = description;
        
        // Data/hora padr√£o: 1 hora a partir de agora
        const now = new Date();
        now.setHours(now.getHours() + 1);
        const year = now.getFullYear();
        const month = (now.getMonth() + 1).toString().padStart(2, '0');
        const day = now.getDate().toString().padStart(2, '0');
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        
        document.getElementById('scheduleDateTime').value = \`\${year}-\${month}-\${day}T\${hours}:\${minutes}\`;

        new bootstrap.Modal(document.getElementById('scheduleModal')).show();
    }

    async function scheduleVideo() {
        const videoPath = document.getElementById('scheduleVideoPath').value;
        const scheduledTime = document.getElementById('scheduleDateTime').value;
        const title = document.getElementById('scheduleTitle').value;
        const description = document.getElementById('scheduleDescription').value;
        
        const videoIndex = currentVideos.findIndex(v => v.path === videoPath);
        const video = currentVideos[videoIndex];
        const thumbnailPath = video.generatedContent?.thumbnail_path || null;

        if (!videoPath || !scheduledTime || !title) {
            alert('Preencha todos os campos obrigat√≥rios (Caminho do V√≠deo, Data/Hora, T√≠tulo)');
            return;
        }

        const loadingToast = showLoadingToast('Agendando v√≠deo...');

        try {
            const response = await fetch('/user/videos/schedule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ videoPath, scheduledTime, title, description, thumbnailPath })
            });
            const data = await response.json();
            loadingToast.remove();

            if (data.success) {
                const toast = document.createElement('div');
                toast.className = 'alert alert-success position-fixed top-0 start-50 translate-middle-x mt-3';
                toast.style.zIndex = '9999';
                toast.style.maxWidth = '500px';
                toast.innerHTML = \`
                    <strong>‚úÖ V√≠deo agendado com sucesso!</strong>
                \`;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 5000);
                new bootstrap.Modal(document.getElementById('scheduleModal')).hide();
                
                // Recarregar a lista de v√≠deos
                loadDefaultFolder();
            } else {
                alert('Erro: ' + data.error);
            }
        } catch (error) {
            loadingToast.remove();
            alert('Erro: ' + error.message);
        }
    }

    function openPublishModal(index) {
        const video = currentVideos[index];
        if (!video) return;

        // Se j√° tem conte√∫do gerado, usar ele
        const title = video.generatedContent?.title || video.name.replace(/\.[^/.]+$/, '').replace(/[()]/g, ' ').trim();
        const description = video.generatedContent?.description || '#shorts';
        const thumbnailUrl = video.generatedContent?.thumbnailUrl || null;

        document.getElementById('publishVideoPath').value = video.path;
        document.getElementById('publishTitle').value = title;
        document.getElementById('publishDescription').value = description;
        
        const publishThumbnailImg = document.getElementById('publishThumbnailPreview');
        const publishThumbnailPreviewSection = document.getElementById('publishThumbnailPreviewSection');

        if (thumbnailUrl) {
            publishThumbnailImg.src = thumbnailUrl;
            publishThumbnailPreviewSection.style.display = 'block';
        } else {
            publishThumbnailImg.src = '';
            publishThumbnailPreviewSection.style.display = 'none';
        }

        new bootstrap.Modal(document.getElementById('publishModal')).show();
    }

    async function publishVideo() {
        const videoPath = document.getElementById('publishVideoPath').value;
        const title = document.getElementById('publishTitle').value;
        const description = document.getElementById('publishDescription').value;
        
        const videoIndex = currentVideos.findIndex(v => v.path === videoPath);
        const video = currentVideos[videoIndex];
        
        // Pegar o thumbnail do conte√∫do gerado, se houver
        const thumbnailPath = video.generatedContent?.thumbnail_path || null;

        if (!videoPath || !title) {
            alert('Preencha todos os campos obrigat√≥rios (Caminho do V√≠deo, T√≠tulo)');
            return;
        }

        const loadingToast = showLoadingToast('Publicando v√≠deo...');

        try {
            const response = await fetch('/user/videos/publish', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ videoPath, title, description, thumbnail_path: thumbnailPath })
            });
            const data = await response.json();
            loadingToast.remove();

            if (data.success) {
                const toast = document.createElement('div');
                toast.className = 'alert alert-success position-fixed top-0 start-50 translate-middle-x mt-3';
                toast.style.zIndex = '9999';
                toast.style.maxWidth = '500px';
                toast.innerHTML = \`
                    <strong>‚úÖ V√≠deo publicado com sucesso!</strong><br>
                    <a href="\${data.videoUrl}" target="_blank" class="alert-link">Ver no YouTube ‚Üí</a>
                \`;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 5000);
                new bootstrap.Modal(document.getElementById('publishModal')).hide();
                
                // Recarregar a lista de v√≠deos
                loadDefaultFolder();
            } else {
                alert('Erro: ' + data.error);
            }
        } catch (error) {
            loadingToast.remove();
            alert('Erro: ' + error.message);
        }
    }

    function showLoadingToast(message) {
        const toast = document.createElement('div');
        toast.className = 'alert alert-info position-fixed top-0 start-50 translate-middle-x mt-3';
        toast.style.zIndex = '9999';
        toast.style.maxWidth = '500px';
        toast.innerHTML = \`
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></div>
                <strong>\${message}</strong>
            </div>
        \`;
        document.body.appendChild(toast);
        return toast;
    }

    // Carregar v√≠deos da pasta padr√£o ao carregar a p√°gina
    document.addEventListener('DOMContentLoaded', () => {
        const defaultFolder = "<%= defaultFolder %>";
        if (defaultFolder) {
            document.getElementById('folderPath').value = defaultFolder;
            loadDefaultFolder();
        }
    });
</script>
` }) %>
